<!DOCTYPE html>
<html lang="en">
<head>
{% include "operations/operations_css.html" %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.js" type="text/javascript"></script>
<script>

function posted (event) {
    event.preventDefault();
    
    $.ajaxSetup ({cache: false});

    var mySpan = $(this);
    var url = mySpan.attr("url");
    if (!url) {
        url = document.getElementById("id_source_start_urls").value;
    }
    if (!url) { 
        url = "http://www.google.com"
    }
    
    var allowP = document.getElementById("id_source_allowParse").value;
    var allowF = document.getElementById("id_source_allowFollow").value;
    var denyP = document.getElementById("id_source_denyParse").value;
    var denyF = document.getElementById("id_source_denyFollow").value;

    var level = mySpan.attr("level");
    var linkno = mySpan.attr("linkno");
    var div = "#linklevel" + String(level) + "_" + String(linkno);
    if (level == "0"){
        urllink = url.split(";")
        for (var i = 0; i < urllink.length; i++) {
            if (urllink[i].substring(0,4).toLowerCase() != "http") {
                alert("Please check your URLs. URLs should start with 'http'.");
                return;
            }
        }
    }
    
    $.post("{% url 'operations.views.tree' %}",
            {csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
            level: level,
            linkno: linkno,
            url : url,
            allowF : allowF,
            allowP : allowP,
            denyF : denyF,
            denyP: denyP
            },
            function(data) {
                console.log('data');
                $( div ).empty().append( data );
                $( div ).delegate("a","click", posted);

            });

}

$(document).ready(function() { $("#tree").on("click",posted);});
 
</script>
</head>
{% include "operations/operations_navbar.html" %}
<div class="container">
    {% if site_id == '0' %}
    <h1>New Site</h1>
    {% else %}
    <h1>Site {{ site_id }}</h1>
    {% endif %}
<form action="{% url 'operations.views.site' site_id %}" method="post" role="form">
{% csrf_token %}

<div class="row">
    <div class="col-xs-3">
        {{ site_form.name.label_tag }}
        {{ site_form.name }}
    </div>
    <div class="col-xs-3">
        {{ site_form.grouping.label_tag }}
        {{ site_form.grouping }}
    </div>
    <div class="col-xs-3">
        {{ site_form.depthlimit.label_tag }}
        {{ site_form.depthlimit }}
    </div>
    <div class="col-xs-3">
        {{ site_form.jurisdiction.label_tag }}
        {{ site_form.jurisdiction }}
    </div>
</div>
<br>
<div class="row">
    <div class="col-xs-4">
        {{ site_form.source_allowed_domains.label_tag }}
        {{ site_form.source_allowed_domains }}
    </div>

    <div class="col-xs-4">
        {{ site_form.source_start_urls.label_tag }}
        {{ site_form.source_start_urls }}
    </div>
</div>

<br>
<div class="row">
    <div class="col-xs-4">
        {{ site_form.source_allowParse.label_tag }}
        {{ site_form.source_allowParse }}
    </div>

    <div class="col-xs-4">
        {{ site_form.source_denyParse.label_tag }}
        {{ site_form.source_denyParse }}
    </div>
</div>

<br>
<div class="row">
    <div class="col-xs-4">
        {{ site_form.source_allowFollow.label_tag }}
        {{ site_form.source_allowFollow }}
    </div>

    <div class="col-xs-4">
        {{ site_form.source_denyFollow.label_tag }}
        {{ site_form.source_denyFollow }}
    </div>
</div>
<br>
<div class="row">
    <center>
    <div class="col-xs-2">
        <h4>Parse Tree</h4>
        <a class="btn btn-default btn-block" href="#" id="tree" level=0 linkno=0>Start URL Tree</a>
    </div>

    <div class="col-xs-2">
        <h4>Save Site</h4>
        <input type="submit" value="Submit" class="btn btn-default btn-block"> 
    </div>
    <div class="col-xs-2">
        <h4>Crawler</h4>
    </div>

    <div class="col-xs-2">
        <h4>Document Database</h4>
        <a class="btn btn-default btn-block" href="{% url 'operations.views.reset_to_zero' site_id %}">Reset To Zero</a>
        <a class="btn btn-default btn-block" href="{% url 'operations.views.duplicate_filter' site_id %}">Duplicate Filter</a>
    </div>
    <div class="col-xs-2">
        <h4>ES Indexing</h4> 
        <a class="btn btn-default btn-block" href="{% url 'operations.views.es_delete' site_id %}">ES Index Delete only</a>
    </div>
    </center>
</div>
</form>

<br>
<div class="row">
    <div class="col-xs-12">

        <style>
            div.tree { padding-left: 20px; }
            a.parsed { color:green;}
            a.denied { color:red;}
        </style>
    <div id="linklevel0_0" class="tree">
    </div>
</div>
</div>
<br>
{% if docs %}
<hr>
Document Count : {{ doc_count }} || Zero Count : {{ zero_count }}
<table class="table">
<tr>
<td>
    <b>Is Used</b>
</td>
<td>
    <b>URL</b>
</td>
</tr>
{% for doc in docs %}
<tr>
<td>
{{ doc.isUsed }}
</td>
<td>
<a href="{{ doc.urlAddress }}">{{ doc.urlAddress }} </a>
</td>
</tr>
{% endfor %}
{% endif %}
</div>
</html>
