<!DOCTYPE html>
<html lang="en">
<head>
    {% include "operations/operations_css.html" %} <!-- CSS FILE -->
    <!-- side bar CSS -->
    <link href="{{ STATIC_URL }}operations.css" rel="stylesheet" type="text/css">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.js" type="text/javascript"></script>
    <script>
        function validateSAD() {
            var source_allowed_domains = document.getElementById("id_source_allowed_domains").value;
            var domain_last_char =  source_allowed_domains.substr(-1);
            if (domain_last_char == ";" || domain_last_char == "/"){
                alert('Source allowed domain should not end with ; or /');
                return;
            }
        }

        function validateForm() {
            if ($('#id_source_allowed_domains').val().length == 0 ||
                    $('#id_source_start_urls').val().length ==0 ||
                    $('#name').val().length == 0) {
                alert('Please fill in name / allowed domains/ start urls');
                return;
            }
        }
        
        function validating() {
            validateForm();
            validateSAD();
        }

       $( function () {
            $('#submit').on("click",validating);

            $('a[name="confirm"]').click(function() {
                return window.confirm(this.title || 'Proceed?');
            });

            $("#tree").on("click",posted);
        });

        function posted (event) {
            event.preventDefault();

            $.ajaxSetup ({cache: false});
            validateSAD();

            var mySpan = $(this);
            var url = mySpan.attr("url");
            if (!url) {
                url = document.getElementById("id_source_start_urls").value;
            }
            if (!url) {
                url = "http://www.google.com"
            }

            var parse_parameters = document.getElementById("id_parse_parameters").value;
            var follow_parameters = document.getElementById("id_follow_parameters").value;
            var deny_parameters = document.getElementById("id_deny_parameters").value;
            var source_allowed_domains = document.getElementById("id_source_allowed_domains").value;
            

            var level = mySpan.attr("level");
            var linkno = mySpan.attr("linkno");
            var div = "#linklevel" + String(level) + "_" + String(linkno);

            if(!$(div).is(':empty') && level > 0){
                $( div ).empty();
                return;
            }

            if (level == "0"){
                urllink = url.split(";")
                for (var i = 0; i < urllink.length; i++) {
                    if (urllink[i].substring(0,4).toLowerCase() != "http") {
                        alert("Please check your URLs. URLs should start with 'http'.");
                        return;
                    }
                }
            }

            $.post("{% url 'tree' %}",
                {csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                level: level,
                linkno: linkno,
                url : url,
                parse_parameters : parse_parameters,
                follow_parameters : follow_parameters,
                deny_parameters : deny_parameters,
                source_allowed_domains : source_allowed_domains
            },
            function(data) {
                $( div ).empty().append( data );
                $( div ).delegate("a","click", posted);

            });

        }

    </script>
</head>
{% include "operations/operations_navbar.html" %} <!-- NAV BAR -->

<!-- Main Content below Top Nav Bar -->
<div class="container-fluid">
    <div class="row">

        <!-- Left Sidebar -->
        <div class="col-sm-3 col-md-2 sidebar">
            <form action="{% url 'operations.views.site.site' site_id %}" method="post" role="form">
                {% csrf_token %} <!-- HTTP: post method's authentication -->
                <ul class="nav nav-sidebar">
                    <li class="active">
                        {{ site_form.name.label_tag }}
                        {{ site_form.name }}
                    </li>
                    <li class="active">
                        {{ site_form.grouping.label_tag }}
                        {{ site_form.grouping }}
                    </li>
                    <li class="active">
                        {{ site_form.depthlimit.label_tag }}
                        {{ site_form.depthlimit }}
                    </li>
                    <li class="active">
                        {{ site_form.jurisdiction.label_tag }}
                        {{ site_form.jurisdiction }}
                    </li>
                    <li class="active">
                        {{ site_form.source_allowed_domains.label_tag }}
                        {{ site_form.source_allowed_domains }}
                    </li>
                    <li class="active">
                        {{ site_form.source_start_urls.label_tag }}
                        {{ site_form.source_start_urls }}
                    </li>
                    <li class="active">
                        <br>For blogs w/ dates in URL:<br>
                        r'/\d{4}/\d{2}/[^\s\\]+/' picks<br>
                        eg.com/2010/12/01/
                    </li>
                    <li class="active">
                        {{ site_form.parse_parameters.label_tag }}
                        {{ site_form.parse_parameters }}
                    </li>
                    <li class="active">
                        {{ site_form.follow_parameters.label_tag }}
                        {{ site_form.follow_parameters }}
                    </li>
                    <li class="active">
                        {{ site_form.deny_parameters.label_tag }}
                        {{ site_form.deny_parameters }}
                    </li>
                </ul>
            </div>

            <!-- Right Side -->
            <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
                {% if site_id == '0' %} <!-- 0 is for CREATE NEW SITE -->
                <h3 style="margin-bottom: 20px">New Site</h3>
                {% else %}
                <h2>Site {{ site_id }}{% if running == 1 %} [crawling] {% endif %}</h2>
                {% endif %}

                <!-- Buttons -->
                <div class="row">
                    {% if docs %}
                    <div class="col-xs-2">
                        <ul class="list-group">
                            <li class="list-group-item">
                                <span class="badge">{{ doc_count }}</span>
                                Document count
                            </li>
                            <li class="list-group-item">
                                <span class="badge">{{ zero_count }}</span>
                                Zero count
                            </li>
                            <li class="list-group-item">
                                <span class="badge">{{ index_count }}</span>
                                Index count
                            </li>
                        </ul>
                    </div>
                    {% endif %}

                    <div class="col-xs-2">
                        <!-- <h5>Tree</h5> -->
                        <a class="btn btn-primary btn-block" href="#" id="tree" level=0 linkno=0>Show Tree</a>
                        <!-- FOR ABOVE: btn = button; but-primary = blue; btn-block = size2 -->
                    </div>
                    <div class="col-xs-2">
                        <!-- <h5>Save Site</h5> -->
                        <input id="submit" type="submit" value="Save Site" class="btn btn-primary btn-block">
                        <a name="confirm" class="btn btn-default btn-block" href="{% url 'operations.views.site.delete' site_id %}">Delete site</a>
                    </div>
                    <div class="col-xs-2">
                        <!-- <h5>Crawler</h5> -->
                        {% if site_id != 0 %}
                        <a class="btn btn-primary btn-block" href="{% url 'operations.views.site.crawl' site_id %}">Crawl</a>
                        <a class="btn btn-default btn-block" href="{% url 'operations.views.site.clear_crawl_schedule' site_id %}">Clear Schedule</a>
                        {% endif %}
                    </div>
                    <div class="col-xs-2">
                        <!-- <h5>Document</h5> -->
                        <a class="btn btn-default btn-block" href="{% url 'operations.views.site.document_duplicate_filter' site_id %}">Dup Filter</a>
                        <a class="btn btn-default btn-block" href="{% url 'operations.views.site.document_reset_to_zero' site_id %}">Reset IsUsed to 0</a>
                        <a class="btn btn-default btn-block" href="{% url 'operations.views.site.document_delete' site_id %}">Delete all in DB</a>
                    </div>
                    <div class="col-xs-2">
                        <!-- <h4>ES Indexing</h4> -->
                        <a class="btn btn-primary btn-block" href="{% url 'operations.views.site.es_index_site' site_id %}"> Index site</a>
                        <a class="btn btn-default btn-block" href="{% url 'operations.views.site.es_remove_site_from_index' site_id %}">Remove from index</a>
                    </div>
                </div>
            </form>
            <br>

            <!-- Tree Display -->
            <div class="row">
                <div class="col-xs-12">
                    <style>
                        div.tree { padding-left: 20px; }
                        a.parsed { color:red;}
                        a.denied { color:gray;}
                        a.followed {color:green;}
                    </style>
                    <div id="linklevel0_0" class="tree">
                    </div>
                </div>
            </div>
            <hr>
            <br>

            <!-- Table Display -->
            {% if docs %} <!-- if there are docs that are being Crawled -->
            <table class="table">
                <tr>
                    <td>
                        <b>Is Used</b>
                    </td>
                    <td>
                        <b>URL</b>
                    </td>
                    <td>
                        <b>HTML</b>
                    </td>
                </tr>
                {% for doc in docs %} <!-- LOOP: for list of docs w/ unknown/variable count -->
                <tr>
                    <td>
                        {{ doc.isUsed }}
                    </td>
                    <td>
                        <a href="{{ doc.urlAddress }}">{{ doc.urlAddress }} </a>
                    </td>
                    <td>
                        <a href="{% url 'get_document' doc.id %}">view</a>
                    </td>
                </tr>
                {% endfor %} <!-- LOOP CLOSURE -->
                {% endif %}
            </table>

        </div>
    </div>
</div>
</html>
